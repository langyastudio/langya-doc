> 本文来自JavaGuide，郎涯进行简单排版与补充



## RPC

### 什么是 RPC

RPC（Remote Procedure Call）— **远程过程调用**，它是一种**通过网络从远程计算机程序上请求服务**，而不需要了解底层网络技术的协议。比如两个不同的服务 A、B 部署在两台不同的机器上，那么服务 A 如果想要调用服务 B 中的某个方法该怎么办呢？使用 HTTP请求 当然可以，但是可能会比较慢而且一些优化做的并不好。 RPC 的出现就是为了解决这个问题。



### RPC 流程

![RPC原理图](https://img-note.langyastudio.com/202111301712434.jpeg?x-oss-process=style/watermark)

1. 服务消费端（client）以本地调用的方式调用远程服务
2. 客户端 Stub（client stub） 接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体（序列化）：`RpcRequest`
3. 客户端 Stub（client stub） 找到远程服务的地址，并将消息发送到服务提供端
4. 服务端 Stub（桩）收到消息将消息反序列化为Java对象: `RpcRequest`
5. 服务端 Stub（桩）根据`RpcRequest`中的类、方法、方法参数等信息调用本地的方法
6. 服务端 Stub（桩）得到方法执行结果并将组装成能够进行网络传输的消息体：`RpcResponse`（序列化）发送至消费方
7. 客户端 Stub（client stub）接收到消息并将消息反序列化为Java对象:`RpcResponse` ，这样也就得到了最终结果



下面再贴一个网上的时序图，辅助理解：

![RPC原理时序图](https://img-note.langyastudio.com/202111301718202.jpeg?x-oss-process=style/watermark)



### RPC 解决了什么问题

让分布式或者微服务系统中**不同服务之间的调用像调用本地方法一样简单**



### RPC 框架

- RMI（JDK自带）：JDK自带的RPC，有很多局限性，不推荐使用
- Dubbo：Dubbo 是阿里巴巴公司开源的一个高性能优秀的服务框架，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和 Spring 框架无缝集成。目前 Dubbo 已经成为 Spring Cloud Alibaba 中的官方组件
- gRPC ：gRPC 是可以在任何环境中运行的现代开源高性能 RPC 框架。它可以通过可插拔的支持来有效地连接数据中心内和跨数据中心的服务，以实现负载平衡，跟踪，运行状况检查和身份验证。它也适用于分布式计算的最后一英里，以将设备，移动应用程序和浏览器连接到后端服务
- Hessian：Hessian是一个轻量级的 remoting on http 工具，使用简单的方法提供了 RMI 的功能。 相比WebService，Hessian 更简单、快捷。因为采用的是二进制协议，所以它很适合于发送二进制数据
- Thrift：Apache Thrift 是 Facebook 开源的跨语言的 RPC 通信框架，目前已经捐献给 Apache 基金会管理，由于其跨语言特性和出色的性能，在很多互联网公司得到应用，有能力的公司甚至会基于 thrift 研发一套分布式服务框架，增加诸如服务注册、服务发现等功能



## 为啥使用 RPC

### RPC 只是一种设计而已

RPC 只是一种概念、一种设计，就是为了解决 **不同服务之间的调用问题**，它一般会包含有 **传输协议** 和 **序列化协议** 这两个。

- 传输协议包含：如著名的 [gRPC](grpc / grpc.io) 使用的 http2 协议，也有如 dubbo 一类的自定义报文的 tcp 协议
- 序列化协议包含：如基于文本编码的 xml json，也有二进制编码的 protobuf hessian等



### HTTP vs TCP

我们通常谈计算机网络的五层协议的体系结构是指：应用层、传输层、网络层、数据链路层、物理层。

应用层协议定义的是应用**进程间的通信和交互的规则**。对于不同的网络应用需要不同的应用层协议。在互联网中应用层协议很多，如**域名系统 DNS**，支持万维网应用的 **HTTP 协议**，支持电子邮件的 **SMTP 协议**等等。我们把应用层交互的数据单元称为报文。HTTP 属于应用层协议，它会基于 TCP/IP 通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。

运输层(transport layer)的主要任务就是负责向两台主机进程之间的通信提供**通用的数据传输服务**。TCP是传输层协议，主要解决数据如何在网络中传输。相比于 UDP，TCP 提供的是提供**面向连接**的，**可靠的**数据传输服务。



### RPC 框架功能更齐全

rpc 框架框架是**面向服务的更高级的封装**，针对服务的**可用性和效率等都做了优化**。成熟的 RPC 框架还提供好了 “服务自动注册与发现”、"智能负载均衡"、“熔断降级”、“运行期流量调度” 等功能，这些也算是选择 RPC 进行服务注册和发现的一方面原因吧！

**相关阅读：**

- http://www.ruanyifeng.com/blog/2016/08/http.html （HTTP 协议入门- 阮一峰）



### 既然有HTTP协议，为什么还要有RPC

- 纯裸 TCP 是能收发数据，但它是个**无边界**的数据流，上层需要定义**消息格式**用于定义**消息边界**。于是就有了各种协议，HTTP 和各类 RPC 协议就是在 TCP 之上定义的应用层协议
- **RPC 本质上不算是协议，而是一种调用方式**，而像 gRPC 和 thrift 这样的具体实现，才是协议，它们是实现了 RPC 调用的协议。目的是希望程序员能像调用本地方法那样去调用远端的服务方法。同时 RPC 有很多种实现方式，**不一定非得基于 TCP 协议**
- 从发展历史来说，HTTP 主要用于 b/s 架构，而 RPC 更多用于 c/s 架构。但现在其实已经没分那么清了，b/s 和 c/s 在慢慢融合。很多软件同时支持多端，所以对外一般用 HTTP 协议，而内部集群的微服务之间则采用 RPC 协议进行通讯
- RPC 其实比 HTTP 出现的要早，且比目前主流的 HTTP1.1 **性能** 要更好，所以大部分公司内部都还在使用 RPC
- **HTTP2.0** 在 **HTTP1.1** 的基础上做了优化，性能可能比很多 RPC 协议都要好，但由于是这几年才出来的，所以也不太可能取代掉 RPC

> 来自：https://mp.weixin.qq.com/s/iA8eXeTMxhFZcLxy8x8TTQ



### 常见的错误观点

很多文章中还会提到说 HTTP 协议相较于自定义 TCP 报文协议，增加的开销在于连接的建立与断开，但是这个观点已经被否认，下面截取自知乎中一个回答，原回答地址：https://www.zhihu.com/question/41609070/answer/191965937 。

>首先要否认一点 HTTP 协议相较于自定义 TCP 报文协议，增加的开销在于连接的建立与断开。HTTP 协议是支持连接池复用的，也就是建立一定数量的连接不断开，并不会频繁的创建和销毁连接。二一要说的是 HTTP 也可以使用 Protobuf 这种二进制编码协议对内容进行编码，因此二者最大的区别还是在**传输协议**上。



