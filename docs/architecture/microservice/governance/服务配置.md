## 为什么要用配置中心 

微服务下，业务的发展一般会导致服务数量的增加，进而导致程序配置（服务地址、数据库参数等等）增多。传统的配置文件的方式已经无法满足当前需求，主要有下面几点原因：

- 安全性得不到保障：配置放在代码库中容易泄露

- 时效性不行：修改配置需要重启服务才能生效

- 不支持权限控制 ：没有对配置的修改、发布等操作进行严格的权限控制

- 不支持配置集中管理 ： 配置文件过于分散，不方便管理

- ......


另外，配置中心通常会自带版本跟踪，会记录配置的修改记录，记录的内容包括修改人、修改时间、修改内容等等。

虽然通过 Git 版本管理我们也能追溯配置的修改记录，但是配置中心提供的配置版本管理功能更全面。并且，配置中心通常会在配置版本管理的基础上支持配置一键回滚。

![d3e6626e-2120-4072-a274-b9d85b307037](https://img-note.langyastudio.com/202212090944295.png?x-oss-process=style/watermark)

一些功能更全面的配置中心比如 Apollo 甚至还支持灰度发布。



## 常见的配置中心

[Spring Cloud Config](https://cloud.spring.io/spring-cloud-config/reference/html/)、[Nacos](https://github.com/alibaba/nacos) 、[Apollo](https://github.com/apolloconfig/apollo)、K8s ConfigMap 、[Disconf](https://github.com/knightliao/disconf) 、[Qconf](https://github.com/Qihoo360/QConf) 都可以用来做配置中心。

Disconf 和 Qconf 已经没有维护，生态也并不活跃，并不建议使用，在做配置中心技术选型的时候可以跳过。

如果你的技术选型是 Kubernetes 的话，可以考虑使用 K8s ConfigMap 来作为配置中心。

Apollo 和 Nacos 我个人更喜欢，两者都是国内公司开源的知名项目，项目社区都比较活跃且都还在维护中。**Nacos 是阿里开源的，Apollo 是携程开源的**。Nacos 使用起来比较简单，并且还可以直接用来做服务发现及管理。Apollo 只能用来做配置管理，使用相对复杂一些。

如果你的项目仅仅需要配置中心的话，建议使用 Apollo 。如果你的项目需要配置中心的同时还需要服务发现及管理的话，那就更建议使用 Nacos。

Spring Cloud Config 属于 Spring Cloud 生态组件，可以和 Spring Cloud 体系无缝整合。由于基于 Git 存储配置，因此 Spring Cloud Config 的整体设计很简单。



##  Apollo vs Nacos vs Spring Cloud Config 

| 功能点       | Apollo                  | Nacos                                    | Spring Cloud Config           |
| ------------ | ----------------------- | ---------------------------------------- | ----------------------------- |
| 配置界面     | 支持                    | 支持                                     | 无（需要通过 Git 操作）       |
| 配置实时生效 | 支持(HTTP 长轮询 1s 内) | 支持(HTTP 长轮询 1s 内)                  | 重启生效，或手动 refresh 生效 |
| 版本管理     | 支持                    | 支持                                     | 支持（依赖 Git）              |
| 权限管理     | 支持                    | 支持                                     | 支持（依赖 Git）              |
| 灰度发布     | 支持                    | 支持（Nacos 1.1.0 版本开始支持灰度配置） | 不支持                        |
| 配置回滚     | 支持                    | 支持                                     | 支持（依赖 Git）              |
| 告警通知     | 支持                    | 支持                                     | 不支持                        |
| 多语言       | 主流语言，Open API      | 主流语言，Open API                       | 只支持 Spring 应用            |
| 多环境       | 支持                    | 支持                                     | 不支持                        |
| 监听查询     | 支持                    | 支持                                     | 支持                          |



Apollo 和 Nacos 提供了更多开箱即用的功能，更适合用来作为配置中心。

**Nacos 使用起来比较简单，并且还可以直接用来做服务发现及管理。Apollo 只能用来做配置管理，使用相对复杂一些。**

Apollo 在配置管理方面做的更加全面，就比如说虽然 Nacos 在 1.1.0 版本开始支持灰度配置，但 Nacos 的灰度配置功能实现的比较简单，Apollo 实现的灰度配置功能就相对更完善一些。不过，Nacos 提供的配置中心功能已经可以满足绝大部分项目的需求了。



## 一个完备配置中心需要具备哪些功能

如果我们需要自己设计一个配置中心的话，需要考虑哪些东西呢？

简单说说我的看法：

- 权限控制 ：配置的修改、发布等操作需要严格的权限控制

- 日志记录 ： 配置的修改、发布等操需要记录完整的日志，便于后期排查问题

- 配置推送 ： 推送模式通常由两种：

- 推 ：实时性变更，配置更新后推送给应用。需要应用和配置中心保持长连接，复杂度高


  - 拉 ：实时性较差，应用隔一段时间手动拉取配置


  - 推拉结合


- 灰度发布 ：支持配置只推给部分应用

- 易操作 ： 提供 Web 界面方便配置修改和发布

- 版本跟踪 ：所有的配置发布都有版本概念，从而可以方便的支持配置的回滚

- 支持配置回滚 ： 我们一键回滚配置到指定的位置，这个需要和版本跟踪结合使用

- ......



## 参考 

[Nacos 1.2.0 权限控制介绍和使用](https://nacos.io/zh-cn/blog/nacos 1.2.0 guide.html)

[Nacos 1.1.0 发布，支持灰度配置和地址服务器模式](https://nacos.io/zh-cn/blog/nacos 1.1.0.html)

[微服务配置中心选型比较](https://www.itshangxp.com/spring-cloud/spring-cloud-config-center/)