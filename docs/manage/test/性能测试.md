> 本文来自JavaGuide，郎涯进行简单排版与补充



性能测试一般情况下都是由测试这个职位去做的，那还需要我们开发学这个干嘛呢？了解性能测试的指标、分类以及工具等知识有助于我们更好地去写出性能更好的程序，另外作为开发这个角色，如果你会性能测试的话，相信也会为你的履历加分不少。

这篇文章是我会结合自己的实际经历以及在测试这里取的经所得，除此之外，我还借鉴了一些优秀书籍，希望对你有帮助。

本文思维导图：

<img src="https://img-note.langyastudio.com/202111301712989.png?x-oss-process=style/watermark" style="zoom:50%;" />



## 不同角色看网站性能

### 用户

当用户打开一个网站的时候，最关注的是什么？当然是**网站响应速度**的快慢。比如我们点击了淘宝的主页，淘宝需要多久将首页的内容呈现在我的面前，我点击了提交订单按钮需要多久返回结果等等。

所以，用户在体验我们系统的时候往往根据你的响应速度的快慢来评判你的网站的性能。



### 开发人员

用户与开发人员都关注速度，这个速度实际上就是我们的系统**处理用户请求的速度**。

开发人员一般情况下很难直观的去评判自己网站的性能，我们往往会根据网站当前的架构以及基础设施情况给一个大概的值，比如：

1. 项目架构是分布式的吗？
2. 用到了缓存和消息队列没有？
3. 高并发的业务有没有特殊处理？
4. 数据库设计是否合理？
5. 系统用到的算法是否还需要优化？
6. 系统是否存在内存泄露的问题？
7. 项目使用的 Redis 缓存多大？服务器性能如何？用的是机械硬盘还是固态硬盘？
8. ...... 



### 测试人员

测试人员一般会根据**性能测试工具**来测试，然后一般会做出一个表格。这个表格可能会涵盖下面这些重要的内容：

1. 响应时间
2. 请求成功率
3. 吞吐量
4. ......



### 运维人员

运维人员会倾向于根据基础设施和**资源的利用率**来判断网站的性能，比如我们的服务器资源使用是否合理、数据库资源是否存在滥用的情况、当然，这是传统的运维人员，现在 Devops 火起来后，单纯干运维的很少了。我们这里暂且还保留有这个角色。



## 性能测试需要注意的点

几乎没有文章在讲性能测试的时候提到这个问题，大家都会讲如何去性能测试，有哪些性能测试指标这些东西。

### 压测结果的影响因素

高并发结果很容易受外界因素影响，压测时需要尽量减少外界因素影响。

影响压测结果外界因素有**本机句柄数限制，dns 解析速度，网络质量，服务端连接数限制等等**。例如使用 1w 并发，很容易出现超过本机最大句柄数限制（一般最大限制 1024），超过句柄数限制的请求会因为句柄数受限导致连接失败。

因此选择**合适并发数对测试接口性能非常重要**，并非并发数越大越好。

实际实践中建议并发数先在 10，100，500，1000 左右分别测试下，如果失败率小于 1%，再考虑逐步增加并发数量。**只有增加并发每秒请求数量能持续增加才是健康的使用方式。当并发数增加到一定数量后，接口响应能力不再增加或者错误数变高，这时候再增加并发量是无效的**。



### 了解系统的业务场景

性能测试之前更需要你了解当前的系统的业务场景。对系统业务了解的不够深刻，我们很容易犯测试方向偏执的错误，从而导致我们忽略了**对系统某些更需要性能测试的地方进行测试**。比如我们的系统可以为用户提供发送邮件的功能，用户配置成功邮箱后只需输入相应的邮箱之后就能发送，系统每天大概能处理上万次发邮件的请求。很多人看到这个可能就直接开始使用相关工具测试邮箱发送接口，但是，发送邮件这个场景可能不是当前系统的性能瓶颈，这么多人用我们的系统发邮件， 还可能有很多人一起发邮件，单单这个场景就这么人用，那用户管理可能才是性能瓶颈吧！



### 历史数据非常有用

当前系统所留下的历史数据非常重要，一般情况下，我们可以通过相应的些历史数据初步判定这个系统哪些接口调用的比较多、**哪些 service 承受的压力最大**，这样的话，我们就可以针对这些地方进行更细致的性能测试与分析。

另外，这些地方也就像这个系统的一个短板一样，优化好了这些地方会为我们的系统带来质的提升。



## 性能测试的指标

### 响应时间

响应时间就是**用户发出请求到用户收到系统处理结果所需要的时间。** 重要吗？实在太重要！

比较出名的 **2-5-8** 原则是这样描述的：通常来说，2到5秒，页面体验会比较好，5到8秒还可以接受，8秒以上基本就很难接受了。另外，据统计当网站慢一秒就会流失十分之一的客户。

但是，在某些场景下我们也并不需要太看重 2-5-8 原则 ，比如我觉得系统导出导入大数据量这种就不需要，系统生成系统报告这种也不需要。



### 并发数

并发数是系统能**同时处理请求的数目**即同时提交请求的用户数目。

不得不说，高并发是现在后端架构中非常非常火热的一个词了，这个与当前的互联网环境以及中国整体的互联网用户量都有很大关系。一般情况下，你的系统并发量越大，说明你的产品做的就越大。但是，并不是每个系统都需要达到像淘宝、12306 这种亿级并发量的。



### 吞吐量

吞吐量指的是系统**单位时间内系统处理的请求数量**。衡量吞吐量有几个重要的参数：QPS（TPS）、并发数、响应时间。

1. QPS（Query Per Second）：服务器每秒可以执行的查询次数
2. TPS（Transaction Per Second）：服务器每秒处理的事务数（这里的一个事务可以理解为客户发出请求到收到服务器的过程）
3. 并发数：系统能同时处理请求的数目即同时提交请求的用户数目
4. 响应时间： 一般取多次请求的平均响应时间



理清他们的概念，就很容易搞清楚他们之间的关系了。

- **QPS（TPS）** = 并发数/平均响应时间
- **并发数** = QPS\平均响应时间

书中是这样描述 QPS 和 TPS 的区别的

> QPS vs TPS：QPS 基本类似于 TPS，但是不同的是，对于一个页面的一次访问，形成一个TPS；但一次页面请求，可能产生多次对服务器的请求，服务器对这些请求，就可计入“QPS”之中。如，访问一个页面会请求服务器2次，一次访问，产生一个“T”，产生2个“Q”。



### 性能计数器

性能计数器是描述服务器或者操作系统的一些**监控指标**如内存使用、CPU使用、磁盘与网络I/O等情况。



## 几种常见的性能测试

### 性能测试

性能测试方法是通过测试工具模拟用户请求系统，目的主要是为了测试系统的性能是否满足要求。通俗地说，这种方法就是要在特定的运行条件下验证系统的能力状态。

性能测试是你在对系统性能已经有了解的前提之后进行的，并且有明确的性能指标。



### 负载测试

对被测试的系统继续加大请求压力，直到服务器的某个**资源达到饱和**了，比如系统的缓存已经不够用了或者系统的响应时间已经不满足要求了。

负载测试说白点就是测试系统的上限。



### 压力测试

不去管系统资源的使用情况，对系统继续加大请求压力，直到服务器崩溃**无法再继续提供服务**。



### 稳定性测试

模拟真实场景，给系统一定压力，看看业务是否能稳定运行。



## 常用性能测试工具

这里就不多扩展了，有时间的话会单独拎一个熟悉的说一下。

### 后端常用

没记错的话，除了 LoadRunner 其他几款性能测试工具都是开源免费的。

- Jmeter 

  Apache JMeter 是 JAVA 开发的性能测试工具。体积小，功能全，支持 http、https、websocket、grpc 等协议的并发压测。但缺点在于**比较消耗单机性能**，一般用于分布式压测或作为压测引擎使用。另外如果只想针对一个接口进行简单测试，需要较深的操作路径，使用起来较为繁琐。

- LoadRunner

  一款商业的性能测试工具

- Galtling 

  一款基于Scala 开发的高性能服务器性能测试工具。

- ab 

  全称为 Apache Bench 。Apache 旗下的一款测试工具，非常实用。它不仅可以对 apache 服务器进行网站访问压力测试，也可以对或其它类型的服务器进行压力测试。比如 nginx、tomcat、IIS 等。但唯一不足的是，ab 基本是命令行执行，如果一个接口需要输入**较复杂的请求参数**，操作起来会比较繁琐。

- Apipost

  自7.0.12版本起，Apipost上线了单接口一键并发功能。能较好的支持单机高并发压测。



### 前端常用

1. Fiddler：抓包工具，它可以修改请求的数据，甚至可以修改服务器返回的数据，功能非常强大，是Web 调试的利器
2. HttpWatch: 可用于录制HTTP请求信息的工具



## 常见的性能优化策略

性能优化之前我们需要对请求经历的各个环节进行分析，排查出可能出现性能瓶颈的地方，定位问题。

下面是一些性能优化时，我经常拿来自问的一些问题：

1. 系统是否需要缓存？
2. 系统架构本身是不是就有问题？
3. 系统是否存在死锁的地方？
4. 系统是否存在内存泄漏？（Java 的自动回收内存虽然很方便，但是，有时候代码写的不好真的会造成内存泄漏）
5. 数据库索引使用是否合理？
6. ......